#!/usr/bin/env bash

RHYTHM="$HOME/.garden/presence/rhythm/state.txt"
PHASE="$HOME/.garden/presence/cycle/phase.txt"
STATE="$HOME/.garden/presence/cycle/state.txt"

# Read rhythm state
R=$(cat "$RHYTHM" 2>/dev/null)

# Read phase counter
P=$(cat "$PHASE" 2>/dev/null)
if [[ -z "$P" ]]; then P=0; fi

# Advance phase on downbeat
if [[ "$R" == "downbeat" ]]; then
  P=$((P + 1))
  echo "$P" > "$PHASE"
fi

# Determine cycle state
if (( P % 4 == 0 )); then
  CSTATE="transition"
elif (( P % 3 == 0 )); then
  CSTATE="crest"
elif (( P % 2 == 0 )); then
  CSTATE="rise"
else
  CSTATE="base"
fi

echo "$CSTATE" > "$STATE"

echo "ðŸŒ¿ Cycle engine updated: phase $P ($CSTATE)"
