#!/usr/bin/env bash

PULSE="$HOME/.garden/presence/pulse/current.txt"
MOM="$HOME/.garden/weave/graph/momentum.txt"
NODES="$HOME/.garden/weave/dynamic/nodes.txt"
OUT="$HOME/.garden/weave/dynamic/map.txt"

CURRENT=$(cat "$PULSE" 2>/dev/null)

# Update node states
TMP="$HOME/.garden/weave/dynamic/nodes.tmp"

while IFS= read -r line; do
  NODE=$(echo "$line" | cut -d':' -f1)
  STATE="idle"

  if [[ "$NODE" == "$CURRENT" ]]; then
    STATE="active"
  elif grep -q "$NODE" "$MOM"; then
    STATE="warm"
  fi

  echo "$NODE: $STATE"
done < "$NODES" > "$TMP"

mv "$TMP" "$NODES"

# Generate the dynamic map
{
  echo "Dynamic Weave Map"
  echo "================="
  echo ""
  echo "Nodes:"
  cat "$NODES"
  echo ""
  echo "Pulse:"
  echo "$CURRENT"
  echo ""
  echo "Momentum (last 20 transitions):"
  cat "$MOM"
} > "$OUT"

echo "ðŸŒ¿ Dynamic weave map updated."
